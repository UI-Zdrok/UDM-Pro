#!/usr/bin/env bash
# -----------------------------------------------------------------------------
# manual_reset.sh
# Мета: показати оператору підказки для натискання кнопки RESET на DUT(ах),
#       залогувати підтвердження, за бажанням перевірити "онлайн" після RESET.
#
# Як працює:
#   - Скрипт читає змінні з середовища/CONF.sh (див. розділ 3 нижче).
#   - Може бути імпортований у test_1.sh (рекомендовано) або запущений окремо.
#
# Навмисно НЕ використовуємо `set -e`, щоб не зупиняти головний сценарій.
# -----------------------------------------------------------------------------

# Обережний режим на невизначені змінні
set -u

# ------------------------------- Налаштування --------------------------------
# Усі ці значення можна переписати у CONF.sh або експортувати перед запуском.
: "${RESET_PROMPT_MODE:=all}"      # "all" – одна підказка для всіх; "per-dut" – окремо для кожного
: "${RESET_HOLD_SECONDS:=10}"      # Скільки тримати кнопку RESET
: "${RESET_TIMEOUT:=90}"           # Таймаут очікування підтвердження (пер-дут)
: "${RESET_CHECK_ONLINE:=0}"       # 1 – після RESET перевіряти, що DUT знову онлайн (ping)
: "${DUT_COUNT:=1}"                # Кількість DUT (макс. 10)

# Додатково для перевірки онлайн (ping):
: "${PING_HOST:=192.168.1.1}"      # Ціль для ping (в тебе спільний IP на всіх VLAN)
: "${PING_TRIES:=20}"              # К-сть спроб
: "${PING_DELAY:=2}"               # Інтервал між спробами, сек

# Куди писати логи:
: "${LOG_DIR:=Logs}"                               # Папка з логами
: "${LOG_DATE:=$(date +%F_%H-%M-%S)}"              # Мітка часу для імен файлів
_log_file="${LOG_DIR}/reset_${LOG_DATE}.log"

# ------------------------------- Службові функції ----------------------------
# Акуратний логер: і в файл, і на екран
_manual_reset_log() {
  mkdir -p "${LOG_DIR}" 2>/dev/null || true
  echo "$@" | tee -a "${_log_file}"
}

# "Натисніть будь-яку клавішу" з підтримкою Enter
_press_any_key() {
  read -n 1 -s -r -p "Натисніть будь-яку клавішу/Enter для продовження..." || true
  echo ""
}

# Очікування, що DUT знову онлайн після RESET (простий ping)
# $1 – індекс DUT (1..N), використовується тільки для логів
_manual_wait_online() {
  local idx="${1:-1}"
  _manual_reset_log "Очікування, що DUT ${idx} знову онлайн (${PING_HOST})..."
  for ((t=1; t<=PING_TRIES; t++)); do
    if ping -c1 -W1 "${PING_HOST}" >/dev/null 2>&1; then
      _manual_reset_log "DUT ${idx} онлайн (спроба ${t}/${PING_TRIES})."
      return 0
    fi
    sleep "${PING_DELAY}"
  done
  _manual_reset_log "УВАГА:_

